# week1 intro

## 1. tutorial练习

```R
library(readr)
library(dplyr)
library(ggplot2)
library(here)

# 1. Read
here()
cereal <- read.csv(here('datasets', 'Cereal.csv'))
cereal %>% glimpse()
cereal %>% summary()

cereal %>% head(7)
cereal %>% class()
cereal %>% colnames()
cereal %>% nrow()
cereal %>% dim()

# 2. Data frames
# Extract the calories column
# vector
cal <- cereal$calories
# dataframe
cal <- cereal %>% select(calories)
# vector
cal <- cereal %>% pull(calories)
# Extract rows 1 to 10 from the cereal data frame.
cereal[1:10, ]
cereal %>% slice(1:10)

# Filter the cereal data frame to include only rows where mfr is "K" and assign it to Kelloggs.
kelloggs <- cereal %>% filter(mfr == "K")

# 3. factors
cereal.with.factors <- read.csv(here('datasets', 'Cereal.csv'), stringsAsFactors = TRUE)
str(cereal.with.factors) # only characters become factors
str(cereal)
levels(cereal.with.factors$mfr)
nlevels(cereal.with.factors$mfr)
str(cereal.with.factors$mfr)

# 4. vectors
cereal.cal <- cereal %>% select(calories) %>% pull()
cereal.cal %>% length()
cereal.cal[5:10]
cereal.cal <- c(cereal.cal, 1.0)
length(cereal.cal)

# 5. matrix
cereal.matrix <- as.matrix(cereal)
is.matrix(cereal.matrix)
cereal.removed <- cereal %>% select(-c(mfr, name, type))
cereal.removed |> colnames()
# Convert the 'cereal.removed' data frame to a numeric matrix.
cereal.numeric.matrix <- as.matrix(cereal.removed)
str(cereal.numeric.matrix)

summary(cereal$sodium)
mean.sodiums <- aggregate(sodium ~ mfr, data = cereal, FUN = mean)
mean.sodiums


# graphs
boxplot(sodium ~ mfr, data = cereal,
        xlab = "Manufacturer", ylab = "Sodium content", main = "Sodium Content by Manufacturer")

cereal %>% 
  ggplot(aes(x= mfr, y = sodium))+
  geom_boxplot() + 
  theme_classic() + 
  labs(x =  "Manufacturer", y = "Sodium content") + 
  ggtitle("Sodium Content by Manufacturer")


plot(calories ~ sodium, data = cereal, main = "Calories versus Sodium Scatter Plot")
cereal %>% 
  ggplot(aes(x = sodium, y = calories)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(x =  "Sodium", y = "Carlories") + 
  ggtitle("Calories versus Sodium Scatter Plot")

# write to file
write.csv(kelloggs, here("datasets", "kelloggs.csv"))

```

## 2. ggplot2 常用“全家桶模板”

```R
library(ggplot2)  # 0. 加载绘图包 ------------------------------------------------

ggplot(
  data = df,      # 1. 数据源
  mapping = aes(  # 2. 全局美学映射：变量 → 视觉元素
    x = x_var,        # 横轴变量
    y = y_var,        # 纵轴变量
    color = group,    # 颜色映射（分类或连续）
    fill = group,     # 填充色映射（柱、面积、箱线图等）
    size = size_var,  # 点/线大小映射
    shape = cat_var,  # 点形状映射（分类）
    linetype = lt_var,# 线型映射（实线、虚线…）
    alpha = a_var,    # 透明度映射
    group = group_var # 分组，如果需要强行划分连线/填充的组
  )
) +
  geom_POINT_OR_LINE(
    data = df_layer,          # 3.1 图层自己的数据（可选，覆盖全局 data）
    mapping = aes(...),       # 3.2 图层自己的映射（可选，覆盖全局 aes）
    stat = "identity",        # 3.3 统计变换方式（计数、密度、回归线等）
    position = "identity",    # 3.4 几何对象位置调整（叠加、并排、抖动）
    show.legend = TRUE,       # 3.5 控制这一层是否出现在图例中
    inherit.aes = TRUE        # 3.6 是否继承全局 aes
  ) +
  stat_SOMETHING(
    mapping = aes(...),       # 4.1 只做统计变换的图层（可以单独设映射）
    geom = "smooth",          # 4.2 统计结果用什么几何对象来画
    position = "identity"     # 4.3 统计图层的位置调整
  ) +
  facet_wrap(                 # 5.1 一维拆分成小图（按某个变量分面）
    ~ facet_var,              #     行列排布由 ~ 右侧的分面变量决定
    nrow = 2, ncol = 3,       #     小图的排布行数、列数
    scales = "fixed"          #     各小图坐标轴是否共享范围（fixed/free）
  ) +
  facet_grid(                 # 5.2 二维分面（行变量 × 列变量）
    rows = vars(row_var),     #     按行划分的小图变量
    cols = vars(col_var),     #     按列划分的小图变量
    scales = "free_y"         #     比如只放开 y 轴范围
  ) +
  scale_x_continuous(         # 6.1 控制 x 轴数值刻度/标签/范围
    name = "X 轴标题",
    limits = c(x_min, x_max),
    breaks = c(...),
    labels = c(...)
  ) +
  scale_y_continuous(         # 6.2 控制 y 轴数值刻度/标签/范围
    name = "Y 轴标题",
    limits = c(y_min, y_max),
    breaks = c(...),
    labels = c(...)
  ) +
  scale_color_manual(         # 6.3 手动指定颜色映射（线/点颜色）
    name   = "颜色图例标题",
    values = c("A" = "red", "B" = "blue"),
    breaks = c("A", "B"),
    labels = c("组A", "组B")
  ) +
  scale_fill_brewer(          # 6.4 使用调色板设置填充色（柱图、箱线图等）
    palette = "Set2"
  ) +
  coord_cartesian(            # 7.1 笛卡尔坐标系，并可裁剪显示范围
    xlim = c(x_min, x_max),
    ylim = c(y_min, y_max),
    expand = TRUE
  ) +
  # coord_flip() +            # 7.2 交换 x/y 轴（水平柱状图等）
  # coord_polar() +           # 7.3 极坐标（饼图、极坐标柱图）
  labs(                       # 8. 添加各种文字标签
    title    = "主标题",
    subtitle = "副标题",
    caption  = "数据来源/备注",
    x        = "X 轴标题",
    y        = "Y 轴标题",
    color    = "颜色图例标题",
    fill     = "填充图例标题",
    size     = "大小图例标题",
    shape    = "形状图例标题"
  ) +
  theme_bw() +                # 9.1 套用一个整体主题风格（背景/网格等）
  theme(                      # 9.2 细调主题（字体、间距、线条、图例位置等）
    text = element_text(family = "STHeiti", size = 12),
    panel.grid.major = element_line(),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  ) +
  guides(                     # 10. 精细控制图例外观和顺序
    color = guide_legend(order = 1),
    fill  = guide_legend(order = 2),
    size  = guide_legend(order = 3)
  ) +
  annotate(                   # 11. 手动加文字/线/箭头等注释
    geom = "text",
    x = x0, y = y0,
    label = "这里是一个关键点",
    hjust = 0, vjust = 1
  )
```

## 3. `geom_smooth(method = "lm", se = FALSE)` 逐个拆开

假设你代码类似这样：

```
ggplot(cereal, aes(x = calories, y = rating)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```

### 1. `geom_smooth(...)` 是干嘛的？

`geom_smooth()`：

> **根据散点数据，画出一条“平滑曲线 / 拟合线”，表示 y 随 x 的总体趋势。**

默认会帮你做两件事：

1. 根据你给的 `x`、`y` 做某种统计拟合（比如平滑曲线、回归线）
2. 把拟合结果画成线（`line`）+ 可选的置信区间带（`ribbon`）

------

### 2. `method = "lm"`

`method` 决定“用什么算法来拟合这条线”。

- `method = "lm"`：

  > 使用 `lm()`（linear model），也就是**线性回归**，画一条直线：
  >  形状是：  y=a+bxy = a + b xy=a+bx

举例：
 `rating ~ calories` 画出来就是“评分随卡路里变化的线性趋势”。

常见的 `method` 还有：

- 不写 `method`：自动选择（小数据量用 `loess`，大数据量用 `gam`）
- `method = "loess"`：本地加权平滑曲线（适合非线性趋势，小数据）
- `method = "gam"`：广义加性模型，更复杂的平滑形式
- `method = "glm"`：广义线性模型，比如 logistic 回归等

你这里写 `method = "lm"` 是明确告诉 ggplot：**我就要一条直线回归线**。

> 另外还可以配合 `formula`，比如：
>
> ```
> geom_smooth(method = "lm", formula = y ~ x)           # 默认线性
> geom_smooth(method = "lm", formula = y ~ poly(x, 2)) # 二次曲线
> ```

------

### 3. `se = FALSE`

`se` 指的是 “standard error” 的那条**置信区间带**。

- `se = TRUE`（默认）：

  > 画出拟合线的同时，在周围加一条半透明的“带子”，代表拟合线的置信区间（默认 95%）。

- `se = FALSE`：

  > **只画线，不画那圈阴影**，图看起来更干净。

比如：

```
geom_smooth(method = "lm", se = TRUE)   # 有带子
geom_smooth(method = "lm", se = FALSE)  # 只有一条线
```

你这里写 `se = FALSE` 就是：**我只想看趋势线，不要那片阴影。**

------

## 4. `geom_smooth()` 的整体用法（帮你建立“模板”认知）

### 1. 最简单的用法

```
ggplot(cars, aes(x = speed, y = dist)) +
  geom_point() +
  geom_smooth()
```

- 不写 `method`：ggplot 会根据数据量自动选方法（小样本用 `loess`，画一条弯曲的平滑线）。
- 默认 `se = TRUE`：会有一条线 + 一圈置信区间。

一句话：**什么都不管，就想看 x–y 散点的总体趋势，用 `geom_smooth()` 就行。**

------

### 2. 常见参数一览（每个一句话）

```
geom_smooth(
  mapping = NULL,     # 这一层自己的 aes（可以覆盖全局 aes）
  data = NULL,        # 这一层单独用的数据
  method = NULL,      # 拟合方法：lm、loess、gam、glm 等
  formula = y ~ x,    # 拟合公式（配合 method，指定模型形式）
  se = TRUE,          # 是否画出置信区间带
  level = 0.95,       # 置信区间置信度（默认 95%）
  span = 0.75,        # loess 平滑程度（越小越“紧”越弯）
  fullrange = FALSE,  # 回归线只画数据范围内/还是扩展整个坐标轴范围
  color = ...,        # 固定设置线的颜色
  linetype = ...,     # 固定设置线型
  size = ...,         # 线的粗细
  inherit.aes = TRUE  # 是否继承 ggplot() 里的 aes
)
```

重点几个：

- `method`：**决定线的“形状类型”**（直？弯？什么算法？）
- `formula`：**告诉它 y 和 x 的关系形式**（直线，多项式……）
- `se`、`level`：**要不要置信区间，以及置信水平是多少**
- `fullrange`：**线是仅覆盖数据范围，还是画满整个坐标轴**
- `mapping`：可以给 `geom_smooth()` 专门设颜色、分组，比如按厂商各自一条线